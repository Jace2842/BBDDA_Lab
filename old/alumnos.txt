@app.route('/alumnos_url', methods=['GET', 'POST'])

def alumnos():

Â  Â  config = load_config()



Â  Â  # ðŸ”¹ POST: Verificar contraseÃ±a y devolver nota sin hacer render

Â  Â  if request.method == 'POST' and request.is_json:

Â  Â  Â  Â  alumno_id = request.json.get("id_alumno")

Â  Â  Â  Â  password = request.json.get("nota_password")



Â  Â  Â  Â  if not alumno_id or not password:

Â  Â  Â  Â  Â  Â  return jsonify({"error": "Faltan datos"}), 400



Â  Â  Â  Â  with psycopg2.connect(**config) as conn:

Â  Â  Â  Â  Â  Â  with conn.cursor() as cur:

Â  Â  Â  Â  Â  Â  Â  Â  valido, mensaje = validar_contraseÃ±a(cur, alumno_id, password)

Â  Â  Â  Â  Â  Â  Â  Â  if not valido:

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return jsonify({"error": mensaje}), 403



Â  Â  Â  Â  Â  Â  Â  Â  cur.execute("SELECT pgp_sym_decrypt(nota::bytea, %s) FROM alumn WHERE id = %s",

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  (password, alumno_id))

Â  Â  Â  Â  Â  Â  Â  Â  nota_descifrada = cur.fetchone()[0]



Â  Â  Â  Â  Â  Â  Â  Â  # Retorna la nota desencriptada en formato JSON

Â  Â  Â  Â  Â  Â  Â  Â  return jsonify({"nota": nota_descifrada}), 200



Â  Â  # ðŸ”¹ GET: Mostrar alumnos con un filtro de bÃºsqueda

Â  Â  page = request.args.get('page', 1, type=int)

Â  Â  limit = 30

Â  Â  offset = (page - 1) * limit

Â  Â  search_nombre = request.args.get('search_nombre', '')

Â  Â  search_apellido = request.args.get('search_apellido', '')

Â  Â  search_direccion = request.args.get('search_direccion', '')

Â  Â  search_saldo = request.args.get('search_saldo', '')

Â  Â  search_fecha_inicio = request.args.get('search_fecha_inicio', '')

Â  Â  search_fecha_fin = request.args.get('search_fecha_fin', '')

Â  Â  search_birthday_inicio = request.args.get('search_birthday_inicio', '')

Â  Â  search_birthday_fin = request.args.get('search_birthday_fin', '')



Â  Â  alumnos_dict = []

Â  Â  total_alumnos = 0

Â  Â  has_next = False



Â  Â  try:

Â  Â  Â  Â  with psycopg2.connect(**config) as conn:

Â  Â  Â  Â  Â  Â  with conn.cursor() as cur:

Â  Â  Â  Â  Â  Â  Â  Â  query_conditions = []

Â  Â  Â  Â  Â  Â  Â  Â  query_params = []



Â  Â  Â  Â  Â  Â  Â  Â  # ðŸ” Aplicar filtros

Â  Â  Â  Â  Â  Â  Â  Â  if search_nombre:

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  query_conditions.append("first_name ILIKE %s")

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  query_params.append(f"%{search_nombre}%")

Â  Â  Â  Â  Â  Â  Â  Â  if search_apellido:

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  query_conditions.append("last_name ILIKE %s")

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  query_params.append(f"%{search_apellido}%")

Â  Â  Â  Â  Â  Â  Â  Â  if search_direccion:

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  query_conditions.append("street_address ILIKE %s")

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  query_params.append(f"%{search_direccion}%")

Â  Â  Â  Â  Â  Â  Â  Â  if search_saldo:

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  query_conditions.append("saldo = %s")

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  query_params.append(search_saldo)

Â  Â  Â  Â  Â  Â  Â  Â  if search_birthday_inicio and search_birthday_fin:

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  query_conditions.append("birthday BETWEEN %s AND %s")

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  query_params.extend([search_birthday_inicio, search_birthday_fin])

Â  Â  Â  Â  Â  Â  Â  Â  elif search_birthday_inicio:

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  query_conditions.append("birthday >= %s")

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  query_params.append(search_birthday_inicio)

Â  Â  Â  Â  Â  Â  Â  Â  elif search_birthday_fin:

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  query_conditions.append("birthday <= %s")

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  query_params.append(search_birthday_fin)

Â  Â  Â  Â  Â  Â  Â  Â  if search_fecha_inicio and search_fecha_fin:

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  query_conditions.append("lastmodified BETWEEN %s AND %s")

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  query_params.extend([search_fecha_inicio, search_fecha_fin])

Â  Â  Â  Â  Â  Â  Â  Â  elif search_fecha_inicio:

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  query_conditions.append("lastmodified >= %s")

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  query_params.append(search_fecha_inicio)

Â  Â  Â  Â  Â  Â  Â  Â  elif search_fecha_fin:

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  query_conditions.append("lastmodified <= %s")

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  query_params.append(search_fecha_fin)



Â  Â  Â  Â  Â  Â  Â  Â  where_clause = " AND ".join(query_conditions) if query_conditions else "1=1"



Â  Â  Â  Â  Â  Â  Â  Â  # ðŸ”¹ Consulta de alumnos

Â  Â  Â  Â  Â  Â  Â  Â  query = f'''

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  SELECT id, first_name, last_name, street_address,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â TO_CHAR(birthday, 'YYYY-MM-DD') AS birthday,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â lastmodified, saldo, nota, hash_password

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  FROM alumn

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  WHERE {where_clause}

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ORDER BY id

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  LIMIT %s OFFSET %s;

Â  Â  Â  Â  Â  Â  Â  Â  '''

Â  Â  Â  Â  Â  Â  Â  Â  query_params.extend([limit, offset])



Â  Â  Â  Â  Â  Â  Â  Â  cur.execute(query, tuple(query_params))

Â  Â  Â  Â  Â  Â  Â  Â  rows = cur.fetchall()



Â  Â  Â  Â  Â  Â  Â  Â  # ðŸ”¹ Contar alumnos

Â  Â  Â  Â  Â  Â  Â  Â  count_query = f"SELECT COUNT(*) FROM alumn WHERE {where_clause};"

Â  Â  Â  Â  Â  Â  Â  Â  cur.execute(count_query, tuple(query_params[:-2]))

Â  Â  Â  Â  Â  Â  Â  Â  total_alumnos = cur.fetchone()[0]



Â  Â  Â  Â  Â  Â  Â  Â  # ðŸ”¹ Procesar resultados

Â  Â  Â  Â  Â  Â  Â  Â  for u in rows:

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id_alumno, first_name, last_name, street_address, birthday, lastmodified, saldo, encrypted_nota, hash_password = u

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nota_descifrada = '********' Â # ðŸ”’ Ocultar por defecto



Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alumnos_dict.append({

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "id": id_alumno,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "first_name": first_name,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "last_name": last_name,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "street_address": street_address,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "birthday": birthday,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "lastmodified": lastmodified,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "saldo": saldo,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "nota": nota_descifrada

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  })



Â  Â  Â  Â  Â  Â  Â  Â  has_next = len(alumnos_dict) == limit

Â  Â  except Exception as error:

Â  Â  Â  Â  print("âŒ Error en la consulta:", error)



Â  Â  return render_template('menu.html', alumnos_data=alumnos_dict, page=page, has_next=has_next,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â total_alumnos=total_alumnos, search_nombre=search_nombre,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â search_apellido=search_apellido, search_direccion=search_direccion,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â search_fecha_inicio=search_fecha_inicio, search_fecha_fin=search_fecha_fin,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â search_birthday_inicio=search_birthday_inicio, search_birthday_fin=search_birthday_fin,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â search_saldo=search_saldo)





html 



{% if alumnos_data %}

<p>Total de registros: {{ total_alumnos }}</p>

<div class="table-container">

Â  Â  <table>

Â  Â  Â  Â  <tr>

Â  Â  Â  Â  Â  Â  <th>ID</th>

Â  Â  Â  Â  Â  Â  <th>Nombre</th>

Â  Â  Â  Â  Â  Â  <th>Apellido</th>

Â  Â  Â  Â  Â  Â  <th>DirecciÃ³n</th>

Â  Â  Â  Â  Â  Â  <th>CumpleaÃ±os</th>

Â  Â  Â  Â  Â  Â  <th>Ãšltima ModificaciÃ³n</th>

Â  Â  Â  Â  Â  Â  <th>Saldo</th>

Â  Â  Â  Â  Â  Â  <th>Nota</th>

Â  Â  Â  Â  </tr>

Â  Â  Â  Â  {% for alumno in alumnos_data %}

Â  Â  Â  Â  <tr>

Â  Â  Â  Â  Â  Â  <td>{{ alumno.id }}</td>

Â  Â  Â  Â  Â  Â  <td>{{ alumno.first_name }}</td>

Â  Â  Â  Â  Â  Â  <td>{{ alumno.last_name }}</td>

Â  Â  Â  Â  Â  Â  <td>{{ alumno.street_address }}</td>

Â  Â  Â  Â  Â  Â  <td>{{ alumno.birthday }}</td>

Â  Â  Â  Â  Â  Â  <td>{{ alumno.lastmodified }}</td>

Â  Â  Â  Â  Â  Â  <td>{{ alumno.saldo }}</td>

Â  Â  Â  Â  Â  Â  <td>

Â  Â  Â  Â  Â  Â  Â  Â  <form method="POST" class="nota-form" data-alumno-id="{{ alumno.id }}">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="password" name="nota_password" placeholder="ContraseÃ±a">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit">Ver Nota</button>

Â  Â  Â  Â  Â  Â  Â  Â  </form>

Â  Â  Â  Â  Â  Â  Â  Â  <p id="nota-{{ alumno.id }}">**********</p>

Â  Â  Â  Â  Â  Â  </td>

Â  Â  Â  Â  </tr>

Â  Â  Â  Â  {% endfor %}

Â  Â  </table>

</div>

{% endif %}



<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>

Â  Â  $(document).ready(function(){

Â  Â  Â  Â  $(".nota-form").submit(function(event){

Â  Â  Â  Â  Â  Â  event.preventDefault();

Â  Â  Â  Â  Â  Â  var form = $(this);

Â  Â  Â  Â  Â  Â  var alumnoId = form.data("alumno-id");

Â  Â  Â  Â  Â  Â  var password = form.find("input[name='nota_password']").val();



Â  Â  Â  Â  Â  Â  $.ajax({

Â  Â  Â  Â  Â  Â  Â  Â  url: "/alumnos_url",

Â  Â  Â  Â  Â  Â  Â  Â  method: "POST",

Â  Â  Â  Â  Â  Â  Â  Â  contentType: "application/json",

Â  Â  Â  Â  Â  Â  Â  Â  data: JSON.stringify({

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "id_alumno": alumnoId,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "nota_password": password

Â  Â  Â  Â  Â  Â  Â  Â  }),

Â  Â  Â  Â  Â  Â  Â  Â  success: function(response) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Mostrar la nota desencriptada en el campo correspondiente

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  $("#nota-" + alumnoId).text("Nota: " + response.nota);

Â  Â  Â  Â  Â  Â  Â  Â  },

Â  Â  Â  Â  Â  Â  Â  Â  error: function(error) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert("Error al verificar la contraseÃ±a: " + error.responseJSON.error);

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  });

Â  Â  });

</script> 
































@app.route('/alumnos_url', methods=['GET', 'POST'])
def alumnos():
    """
    Endpoint para gestionar alumnos.
    ---
    get:
      description: Obtener lista de alumnos con filtros opcionales
      parameters:
        - name: search_nombre
          in: query
          type: string
          required: false
        - name: search_apellido
          in: query
          type: string
          required: false
        - name: search_direccion
          in: query
          type: string
          required: false
        - name: search_fecha_inicio
          in: query
          type: string
          required: false
        - name: search_fecha_fin
          in: query
          type: string
          required: false
        - name: search_birthday_inicio
          in: query
          type: string
          required: false
        - name: search_birthday_fin
          in: query
          type: string
          required: false
        - name: search_saldo
          in: query
          type: string
          required: false
        - name: page
          in: query
          type: integer
          default: 1
      responses:
        200:
          description: Lista de alumnos obtenida con Ã©xito
    post:
      description: Verificar contraseÃ±a y obtener nota cifrada
      parameters:
        - name: id_alumno
          in: body
          type: integer
          required: true
        - name: nota_password
          in: body
          type: string
          required: true
      responses:
        200:
          description: Nota obtenida correctamente
    """
    config = load_config()
    
    if request.method == 'POST' and request.is_json:
        data = request.get_json()
        alumno_id = data.get("id_alumno")
        password = data.get("nota_password")

        if not alumno_id or not password:
            return jsonify({"error": "Faltan datos"}), 400

        with psycopg2.connect(**config) as conn:
            with conn.cursor() as cur:
                valido, mensaje = validar_contraseÃ±a(cur, alumno_id, password)
                if not valido:
                    return jsonify({"error": mensaje}), 403
                
                cur.execute("SELECT pgp_sym_decrypt(nota::bytea, %s) FROM alumn WHERE id = %s", (password, alumno_id))
                nota_descifrada = cur.fetchone()[0]
                return jsonify({"nota": nota_descifrada}), 200

    # GET para listar alumnos
    page = request.args.get('page', 1, type=int)
    limit = 30
    offset = (page - 1) * limit
    search_nombre = request.args.get('search_nombre', '')
    search_apellido = request.args.get('search_apellido', '')
    search_direccion = request.args.get('search_direccion', '')
    search_fecha_inicio = request.args.get('search_fecha_inicio', '')
    search_fecha_fin = request.args.get('search_fecha_fin', '')
    search_birthday_inicio = request.args.get('search_birthday_inicio', '')
    search_birthday_fin = request.args.get('search_birthday_fin', '')
    search_saldo = request.args.get('search_saldo', '')
    
    alumnos_dict = []
    total_alumnos = 0
    has_next = False

    with psycopg2.connect(**config) as conn:
        with conn.cursor() as cur:
            query = """
                SELECT id, first_name, last_name, street_address, 
                       TO_CHAR(birthday, 'YYYY-MM-DD') AS birthday, lastmodified, saldo 
                FROM alumn
                WHERE first_name ILIKE %s AND last_name ILIKE %s AND street_address ILIKE %s
                ORDER BY id LIMIT %s OFFSET %s;
            """
            cur.execute(query, (f"%{search_nombre}%", f"%{search_apellido}%", f"%{search_direccion}%", limit, offset))
            rows = cur.fetchall()
            
            for u in rows:
                alumnos_dict.append({
                    "id": u[0], "first_name": u[1], "last_name": u[2], "street_address": u[3],
                    "birthday": u[4], "lastmodified": u[5], "saldo": u[6]
                })
            
            cur.execute("SELECT COUNT(*) FROM alumn WHERE first_name ILIKE %s AND last_name ILIKE %s AND street_address ILIKE %s", 
                        (f"%{search_nombre}%", f"%{search_apellido}%", f"%{search_direccion}%"))
            total_alumnos = cur.fetchone()[0]

    has_next = len(alumnos_dict) == limit
    return render_template('menu.html', alumnos_data=alumnos_dict, page=page, has_next=has_next,
                           total_alumnos=total_alumnos, search_nombre=search_nombre,
                           search_apellido=search_apellido, search_direccion=search_direccion,
                           search_fecha_inicio=search_fecha_inicio, search_fecha_fin=search_fecha_fin,
                           search_birthday_inicio=search_birthday_inicio, search_birthday_fin=search_birthday_fin,
                           search_saldo=search_saldo) 


